#include "<df>/dragonfruit.h"

#include "<inc>/OSCalls.h"
#include "<inc>/OSMap.h"
#include "<inc>/OSAccess.h"
#include "<inc>/OSFile.h"
#include "<inc>/OSObject.h"
#include "<inc>/OSEnvironment.h"
#include "<inc>/OSStatus.h"

#include "OSDLL.h"

fn DLLMain { -- }
	// initialize the process image by mapping its sections into the address
	// space and dynamically linking it if necessary.

	// SystemInit.exe is a special case where no image file name is given in
	// the PEB.

	auto ok

	auto imagepath
	OSPEB OSPEBs_Parameters + @ imagepath!

	if (imagepath@ ~~)
		// this is SystemInit.exe

		OSPEB OSPEBs_Parameters + 4 + imagepath!
		imagepath@ OSPEB OSPEBs_Parameters + !

		imagepath@ // dest
		"/mintia/SystemInit.exe" // src
		strcpy

		1 OSPEB OSPEBs_ParameterCount + !

		OSNONE OSPEB OSPEBs_StdIn + !
		OSNONE OSPEB OSPEBs_StdOut + !
		OSNONE OSPEB OSPEBs_StdErr + !

		// initialize current directory as /

		OSNONE OSPEB OSPEBs_CurrentDirectory + !

		"/" // env
		"PWD" // name
		OSSetEnvironmentVariable drop
	end

	auto vaddr
	auto vaddr1
	auto vaddr2

	64 Malloc vaddr1!
	vaddr1@ "0x%08x\n" Printf

	64 Malloc vaddr2!
	vaddr2@ "0x%08x\n" Printf

	64 Malloc vaddr!
	vaddr@ "0x%08x\n" Printf

	vaddr1@ Free
	vaddr2@ Free
	vaddr@ Free

	64 Malloc vaddr!
	vaddr@ "0x%08x\n" Printf

	64 Malloc vaddr!
	vaddr@ "0x%08x\n" Printf

	64 Malloc vaddr!
	vaddr@ "0x%08x\n" Printf

	64 Malloc vaddr!
	vaddr@ "0x%08x\n" Printf

	64 Malloc vaddr!
	vaddr@ "0x%08x\n" Printf

	while (1)
	end
end