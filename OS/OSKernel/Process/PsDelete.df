#include "<df>/dragonfruit.h"

#include "<inc>/HALLog.h"

#include "<inc>/Kernel.h"

#include "<inc>/Executive.h"

#include "<inc>/Memory.h"

#include "<inc>/Object.h"

#include "<inc>/Security.h"

#include "<inc>/Process.h"

#include "<ll>/OSDLL/OSStatus.h"

#include "<inc>/HALCPU.h"

#include "<inc>/HALDebug.h"

fn (ObTypeDeleteFunction) PsProcessObjectDelete { object -- }
	// the last reference to this process object was removed.
	// finally free all resources associated with it.

	// destroy handle table

	pointerof ObHandleDestroyFunction object@ PsProcess_HandleTable + @ ExHandleTableDelete

	// remove from the global process list

	auto rs
	HALCPUInterruptDisable rs!

	auto n
	object@ PsProcess_GlobalListNext + @ n!

	auto l
	object@ PsProcess_GlobalListPrev + @ l!

	if (n@)
		l@ n@ PsProcess_GlobalListPrev + !
	end

	if (l@)
		n@ l@ PsProcess_GlobalListNext + !
	end else
		// no prev means we were the listhead

		n@ PsProcessListHead!
	end

	rs@ HALCPUInterruptRestore

	// deref quota block

	object@ PsProcess_QuotaBlock + @ MmQuotaBlockDereference
end